# 修复 App.tsx 的编码问题
$filePath = "c:\Users\M1133\excel-copilot-addin\src\taskpane\components\App.tsx"

# 读取文件
$content = [System.IO.File]::ReadAllText($filePath, [System.Text.Encoding]::UTF8)

# 定义替换映射 - 乱码 -> 正确的中文
$replacements = @{
    # 欢迎消息
    '���ã����� Excel �������֡�' = '你好！👋 我可以帮你处理 Excel 数据。'
    'ѡ�� Excel �е����ݣ�Ȼ��������������ʲô�����磺' = '试试告诉我：'
    '? ��������Щ���ݡ�' = '• 创建一个销售数据表'
    '? �����͡�' = '• 帮我分析这些数据'
    '? ������ͼ����' = '• 添加一个图表'
    
    # 通用乱码修复
    '�û�ƫ��' = '用户偏好'
    '���ر������û�ƫ��' = '加载保存的用户偏好'
    
    # 状态栏
    '?? 1�� �ĵ� 65��' = '📊 1个文档 65行'
    
    # 按钮和标签
    'д��' = '写入'
    'Ӧ�ù�ʽ' = '应用公式'
    'д�뵥Ԫ��' = '写入单元格'
    'Ӧ��' = '应用'
    
    # 对话框
    'ȷ�ϲ���' = '确认操作'
    '����ִ�����²�����' = '即将执行以下操作：'
    'ȷ��' = '确认'
    'ȡ��' = '取消'
    '����' = '清除'
    '���� API' = '配置 API'
    'DeepSeek API ��Կ' = 'DeepSeek API 密钥'
    '����' = '后端'
    '������' = '已连接'
    'δ����' = '未连接'
    '��ǰ' = '当前'
    '����' = '保存'
    
    # 欢迎界面
    'Excel ��������' = 'Excel 智能助手'
    'ѡ���������򣬸�����������ʲô' = '选中数据区域，告诉我你想做什么'
    '�ܽᵱǰѡ��������' = '总结当前选中的数据'
    '�ܽ�����' = '总结数据'
    'Ϊ��ǰ�������ɹ�ʽ' = '为当前数据生成公式'
    '���ɹ�ʽ' = '生成公式'
    'Ϊ���ݴ������ʵ�ͼ��' = '为数据创建合适的图表'
    '����ͼ��' = '创建图表'
    '�����������ƺ��쳣' = '分析数据趋势和异常'
    '��������' = '分析趋势'
    
    # 输入区域
    '�����������������Ĳ���...' = '描述你想对数据做的操作...'
    '���˷���δ����' = '后端服务未连接'
    
    # 加载状态
    '����ִ��...' = '正在执行...'
    '˼����...' = '思考中...'
    'Copilot ����˼��...' = 'Copilot 正在思考...'
    
    # Agent 相关
    '�����ǵ�������...' = '让我来处理这个任务...'
    '��Ǹ����ʱ�޷�����������ˢ��ҳ����ԡ�' = '抱歉，我暂时无法处理这个任务。请刷新页面后重试。'
    
    # 注释清理（替换为英文注释避免编码问题）
    '/* ===== SECTION ===== */' = '/* ===== SECTION ===== */'
    '/* comment */' = '/* comment */'
}

$fixedCount = 0
foreach ($old in $replacements.Keys) {
    if ($content.Contains($old)) {
        $content = $content.Replace($old, $replacements[$old])
        $fixedCount++
        Write-Host "Fixed: $old"
    }
}

# 保存文件（使用 UTF-8 with BOM）
[System.IO.File]::WriteAllText($filePath, $content, [System.Text.Encoding]::UTF8)

Write-Host ""
Write-Host "Fixed $fixedCount patterns"
Write-Host "Done!"
