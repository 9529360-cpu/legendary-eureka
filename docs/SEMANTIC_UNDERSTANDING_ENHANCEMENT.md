# ProactiveAgent 语义理解增强 (v4.3)

## 🚀 增强概述

从"低级关键词匹配"升级到"智能语义理解"，Agent 现在能理解多种表达方式。

---

## 📊 能力对比

### 修复前（低级）

| 输入 | 结果 |
|------|------|
| `K2=E2-F2` | ✅ 识别 |
| `帮我在 K2 设置 E2-F2` | ❌ 不识别 |
| `在 K2 求和 E2:J2` | ❌ 提示不明确 |
| `K2 等于 E2 减 F2` | ❌ 不识别 |

### 修复后（智能）

| 输入 | 结果 |
|------|------|
| `K2=E2-F2` | ✅ 直接识别 |
| `帮我在 K2 设置 E2-F2` | ✅ 理解并执行 |
| `在 K2 求和 E2:J2` | ✅ 转换为 SUM 公式 |
| `K2 等于 E2 减 F2` | ✅ 理解并执行 |

---

## 🧠 支持的意图类型

### 1. 直接公式 (formula_direct)

**格式：** `单元格=公式`

**示例：**
```
K2=E2-F2-J2-J2
K2=SUM(E2:J2)
A1=B1*1.1
C3=(D3+E3)/2
```

**执行：** 直接设置公式

---

### 2. 自然语言公式 (formula_natural)

**支持的表达：**
- `帮我在 K2 设置 E2-F2`
- `让 K2 等于 E2 减 F2`
- `给 K2 填入 E2-F2`
- `计算 K2: E2-F2`
- `K2 的值是 E2-F2`

**自然语言转换：**
```
"E2 减 F2"        → E2-F2
"E2 加 F2"        → E2+F2
"E2 乘以 F2"      → E2*F2
"E2 除以 F2"      → E2/F2
"E2 到 J2 的和"   → SUM(E2:J2)
"E2 到 J2 平均"   → AVERAGE(E2:J2)
```

---

### 3. 计算指令 (calculation)

#### 求和

**支持的表达：**
```
在 K2 求和 E2:J2
K2 求和 E2:J2
K2 的总和是 E2:J2
求 E2:J2 的和放在 K2
```

**生成公式：** `K2 = SUM(E2:J2)`

#### 平均值

**支持的表达：**
```
在 K2 求平均 E2:J2
K2 的平均值是 E2:J2
计算 E2:J2 平均值到 K2
```

**生成公式：** `K2 = AVERAGE(E2:J2)`

#### 最大值/最小值

**支持的表达：**
```
K2 的最大值是 E2:J2
K2 的最小值是 E2:J2
```

**生成公式：** `MAX(E2:J2)` / `MIN(E2:J2)`

---

### 4. 分析指令 (analyze)

**支持的表达：**
```
分析这个表格
重新分析
统计数据
查看数据
检查表格
```

**执行：** 触发 WorksheetAnalyzer 重新分析

---

### 5. 格式化指令 (format)

**支持的表达：**
```
格式化 A1:B10
设置 A1 为粗体
给 B2 加颜色
```

**状态：** 🚧 正在开发中

---

### 6. 数据操作 (data_operation)

**支持的表达：**
```
删除空行
清除 A1:B10
复制 A1 到 B1
移动数据
```

**状态：** 🚧 正在开发中

---

## 🧪 测试用例

### 测试 1: 直接公式

| 输入 | 预期 K2 结果 | 消息 |
|------|-------------|------|
| `K2=E2-F2-J2-J2` | 计算结果 | 已在 K2 设置公式... |
| `K2=SUM(E2:J2)` | 求和结果 | 已在 K2 设置公式... |
| `K2=E2*1.1` | E2 的 110% | 已在 K2 设置公式... |

---

### 测试 2: 自然语言公式

| 输入 | 理解为 | K2 结果 |
|------|--------|---------|
| `帮我在 K2 设置 E2-F2` | K2=E2-F2 | E2-F2 |
| `让 K2 等于 E2 减 F2` | K2=E2-F2 | E2-F2 |
| `K2 的值: E2 加 F2` | K2=E2+F2 | E2+F2 |
| `计算 K2: E2 乘 F2` | K2=E2*F2 | E2*F2 |

---

### 测试 3: 求和指令

| 输入 | 理解为 | K2 结果 |
|------|--------|---------|
| `在 K2 求和 E2:J2` | K2=SUM(E2:J2) | 求和结果 |
| `K2 求和 E2:J2` | K2=SUM(E2:J2) | 求和结果 |
| `K2 的总和是 E2:J2` | K2=SUM(E2:J2) | 求和结果 |

---

### 测试 4: 不完整指令

| 输入 | Agent 响应 |
|------|-----------|
| `求和` | 请告诉我单元格和范围，例如：K2=SUM(E2:J2) |
| `平均值` | 请告诉我单元格和范围... |
| `K2 求和` | 请告诉我要计算哪个范围... |

---

### 测试 5: 分析指令

| 输入 | 执行 |
|------|------|
| `分析这个表格` | 重新分析工作表 |
| `重新分析` | 重新分析工作表 |
| `统计数据` | 重新分析工作表 |

---

## 🔧 实现细节

### 意图解析流程

```typescript
parseAdvancedIntent(input: string) {
  // 1. 直接公式匹配
  if (/^[A-Z]+\d+=.+$/.test(input)) {
    return { type: "formula_direct", cell, formula };
  }
  
  // 2. 自然语言公式匹配
  if (/帮我在|给|让/.test(input)) {
    return { type: "formula_natural", cell, expression };
  }
  
  // 3. 计算指令匹配
  if (/求和|sum/.test(input)) {
    return { type: "calculation", operation: "sum" };
  }
  
  // 4. 分析指令匹配
  if (/分析|统计/.test(input)) {
    return { type: "analyze" };
  }
  
  // 5. 未知意图
  return { type: "unknown" };
}
```

### 自然语言转公式

```typescript
executeFormulaFromNatural(intent: Intent) {
  let formula = intent.expression;
  
  // 替换中文运算符
  formula = formula
    .replace(/减去?/g, "-")
    .replace(/加上?/g, "+")
    .replace(/乘以?/g, "*")
    .replace(/除以?/g, "/")
    .replace(/求和|的和/g, "SUM")
    .replace(/平均/g, "AVERAGE");
    
  return executeFormula(intent.cell, formula);
}
```

### 智能提示

```typescript
suggestCalculation(operation: string, input: string) {
  return `我理解你想要计算${operation}。

请告诉我：
1. 要把结果放在哪个单元格？（如 K2）
2. 要计算哪个范围的数据？（如 E2:J2）

例如：
• 在 K2 求和 E2:J2
• K2=SUM(E2:J2)`;
}
```

---

## 📊 性能优化

### 正则表达式优化

使用预编译的正则表达式提高匹配速度：

```typescript
// 直接公式
const DIRECT_FORMULA = /^([A-Z]+\d+)\s*=\s*(.+)$/i;

// 自然语言公式
const NATURAL_FORMULAS = [
  /(?:帮我)?(?:在|给)?([A-Z]+\d+)(?:设置|写入|填入)?(.+)/i,
  /(?:让|把)?([A-Z]+\d+)(?:等于|=)(.+)/i,
];

// 计算关键词
const CALCULATION_OPS = {
  sum: /求和|总和|sum/i,
  average: /平均|平均值|average/i,
  max: /最大|max/i,
  min: /最小|min/i,
};
```

---

## 🎯 未来增强

### 1. 上下文感知

**当前：**
```
用户: K2 求和 E2:J2
Agent: ✅ 执行
```

**未来：**
```
用户: 求和 E2:J2
Agent: 要把结果放在哪里？
用户: K2
Agent: ✅ 执行
```

### 2. 批量操作

**当前：** 一次一个单元格

**未来：**
```
用户: K2 到 K10 都求和对应行的 E 到 J
Agent: ✅ 批量设置 10 个公式
```

### 3. 公式优化建议

**未来：**
```
用户: K2=E2-F2-J2-J2
Agent: 我注意到你减了两次 J2，是想写 E2-F2-2*J2 吗？
```

### 4. 学习用户习惯

**未来：**
- 记录常用公式模式
- 自动补全
- 个性化建议

---

## 🐛 已知限制

### 1. 复杂表达式

**不支持：**
```
K2 等于 (E2 加 F2) 除以 2 再减 J2
```

**建议：** 使用标准公式格式

### 2. 多步骤操作

**不支持：**
```
在 K2 求和 E2:J2 然后格式化为货币
```

**建议：** 分步执行

### 3. 条件逻辑

**不支持：**
```
如果 E2 大于 100 就在 K2 写"高"否则写"低"
```

**建议：** 使用 IF 公式

---

## 📝 Git 提交

```bash
90c9ca7 - feat(v4.3): 大幅增强 ProactiveAgent 语义理解能力
```

---

## 🔗 相关文档

- **架构设计**: `.github/copilot-instructions.md`
- **测试清单**: `docs/V4.3_COMPLETE_TEST_CHECKLIST.md`
- **更新日志**: `CHANGELOG.md` (v4.3)
