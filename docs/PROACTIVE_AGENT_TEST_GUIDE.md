# 主动洞察 Agent 测试指南 (v4.3)

## 🎯 功能说明

v4.3 引入了主动洞察型 Agent，它会像一个有经验的分析师：
1. **主动观察** - 打开 Excel 时自动分析工作表
2. **形成判断** - 识别表格结构、数据问题、格式问题
3. **提供建议** - 给出可操作的建议和快速操作按钮
4. **等待确认** - 询问用户是否执行

---

## 🧪 测试步骤

### 1. 启动应用

```bash
npm run dev:full
npm run start
```

### 2. 准备测试数据

在 Excel 中创建一个测试表格，包含以下特征：
- 第一行作为表头（如：日期、姓名、金额）
- 几行数据
- 故意添加一些问题数据：
  - 文本格式存储的数字（在单元格前加单引号：`'123`）
  - 不一致的格式
  - 空行或空列

示例数据：

| 日期       | 姓名 | 金额  | 备注     |
|------------|------|-------|----------|
| 2024-01-01 | 张三 | '100  | 文本格式 |
| 2024-01-02 | 李四 | 200   | 正常     |
|            |      |       | 空行     |
| 2024-01-03 | 王五 | 300   | 正常     |

### 3. 观察主动洞察行为

**期望看到的现象：**

1. **自动分析**
   - 打开 Add-in 后，会自动显示 "🔍 正在分析工作表..." 进度条
   - 几秒后完成分析

2. **洞察消息**
   - 在聊天区域自动出现 Agent 的分析消息，类似：
     ```
     我刚看了这个 Sheet1。
     这是一个标准表格，第 1 行是表头。
     有 1 个时间相关的列（日期）。
     1 个数值列，适合做计算和汇总。
     
     ⚠️ 发现一些需要注意的问题：
       • 金额列：存在文本格式的数字
       • 发现空行
     
     我可以帮你：
       • 转换为正式表格
       • 修正数值格式
       • 删除空行
     ```

3. **快速操作按钮**
   - 在洞察面板下方显示快速操作按钮
   - 例如：`转换为表格`、`修正格式`、`删除空行`、`✓ 全部执行`
   - 点击按钮可以快速执行对应操作

### 4. 测试快速操作

**点击单个按钮：**
- 点击任何一个快速操作按钮（如 "修正格式"）
- Agent 会执行该操作并返回结果

**点击"全部执行"：**
- 点击绿色的 "✓ 全部执行" 按钮
- Agent 会依次执行所有建议
- 在聊天区域显示执行进度和结果

### 5. 测试工作表切换

**切换到另一个工作表：**
- 在 Excel 中切换到不同的工作表
- Agent 应该会自动重新分析新工作表
- 显示新的洞察和建议

---

## ✅ 验证清单

- [ ] 打开 Add-in 后会自动分析工作表
- [ ] 显示 "🔍 正在分析工作表..." 进度条
- [ ] 聊天区域自动出现洞察消息（像人说话一样）
- [ ] 洞察消息包含：
  - [ ] 表格结构描述
  - [ ] 列类型识别
  - [ ] 问题列举
  - [ ] 可操作的建议
- [ ] 在洞察面板下方显示快速操作按钮
- [ ] 快速操作按钮可以点击并执行
- [ ] "全部执行"按钮可以一次性执行所有建议
- [ ] 切换工作表时会自动重新分析
- [ ] 分析过程中显示进度条
- [ ] 没有报错或崩溃

---

## 🐛 如果没有看到效果

### 问题排查

1. **检查 useProactiveAgent 是否初始化**
   - 打开浏览器控制台（F12）
   - 查看是否有 ProactiveAgent 相关日志
   - 确认 `autoAnalyzeOnStart: true` 配置已生效

2. **检查是否有错误**
   - 查看控制台是否有 TypeScript 或 React 错误
   - 查看网络请求是否正常（AI 后端连接）

3. **手动触发分析**
   - 在输入框输入: "分析这个工作表"
   - 看是否能触发分析

4. **清除缓存**
   ```powershell
   .\scripts\clear_wef.ps1
   ```
   - 关闭 Excel
   - 重新启动 `npm run start`

---

## 📝 设计对比

### 旧版 Agent（被动型）

```
用户: 帮我整理这个表格
Agent: [执行中...]
Agent: 任务完成
```

### 新版 Agent（主动型 v4.3）

```
[自动启动]
Agent: 我刚看了这个 Sheet1...
       [详细分析和建议]
       你是想全部一起做，还是先改某几项？

[显示快速操作按钮]
[转换为表格] [修正格式] [删除空行] [✓ 全部执行]

用户: [点击按钮或输入确认]
Agent: [执行操作并返回结果]
```

---

## 🔗 相关文件

- **Agent 核心**: `src/agent/proactive/ProactiveAgent.ts`
- **分析器**: `src/agent/proactive/WorksheetAnalyzer.ts`
- **洞察生成**: `src/agent/proactive/InsightGenerator.ts`
- **React Hook**: `src/taskpane/hooks/useProactiveAgent.ts`
- **UI 集成**: `src/taskpane/components/App.tsx`

---

## 📚 更多文档

- 完整更新日志：`CHANGELOG.md` (搜索 v4.3)
- 架构设计：`.github/copilot-instructions.md`
